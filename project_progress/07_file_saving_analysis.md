# Анализ и оптимизация сохранения файлов в inbox

## Проблема

В папку `var/inbox` сохранялись только файлы, которые обрабатывались для транскрипции:
- voice (голосовые сообщения)
- audio (аудио файлы)
- video (видео файлы)
- video_note (кружочки)
- document (только аудио/видео)

Не сохранялись:
- photo (фотографии)
- sticker (стикеры)
- animation (GIF анимации)
- document (другие типы документов)

## Реализованное решение

### Изменения в `src/bot/router.py`

1. Добавлена универсальная функция `_save_file_to_inbox()`:
   - Сохраняет любой файл в `var/inbox`
   - Проверяет существование файла перед сохранением
   - Логирует операции
   - Обрабатывает ошибки без прерывания работы бота

2. Расширена обработка в `on_message()`:
   - photo: сохраняется самый большой размер
   - sticker: сохраняется с определением расширения из mime_type
   - animation: сохраняются GIF анимации
   - document: сохраняются все документы, не только аудио/видео

### Изменения в `src/bot/middleware.py`

Добавлена поддержка новых типов сообщений в логирование:
- video (было пропущено)
- photo
- sticker
- animation

## Варианты оптимизации

### 1. Асинхронное сохранение файлов (рекомендуется)

**Текущая реализация**: Файлы сохраняются синхронно перед обработкой сообщения.

**Оптимизация**: Сохранять файлы в фоновой задаче, не блокируя обработку сообщения.

```python
import asyncio

async def _save_file_to_inbox_async(bot: Bot, file_id: str, filename: str, message_type: str):
    """Save file in background task."""
    asyncio.create_task(_save_file_to_inbox(bot, file_id, filename, message_type))
```

**Преимущества**:
- Не блокирует обработку сообщений
- Быстрее ответ пользователю
- Меньше таймаутов при больших файлах

**Недостатки**:
- Сложнее обработка ошибок
- Нужен механизм отслеживания статуса сохранения

### 2. Фильтрация типов файлов

**Текущая реализация**: Сохраняются все файлы.

**Оптимизация**: Добавить конфигурацию для выбора типов файлов для сохранения.

```yaml
# settings.yaml
file_saving:
  enabled: true
  types:
    - voice
    - audio
    - video
    - video_note
    - photo
    - document
  skip_types:
    - sticker
    - animation
```

**Преимущества**:
- Экономия места на диске
- Быстрее работа при большом количестве стикеров/анимаций
- Гибкая настройка

**Недостатки**:
- Усложнение конфигурации
- Может быть неочевидно для пользователя

### 3. Сжатие изображений

**Текущая реализация**: Фото сохраняются в оригинальном размере.

**Оптимизация**: Автоматически сжимать большие изображения.

**Преимущества**:
- Экономия места на диске
- Быстрее загрузка/сохранение

**Недостатки**:
- Потеря качества
- Дополнительная обработка
- Требует библиотеки для работы с изображениями

### 4. Организация файлов по типам/датам

**Текущая реализация**: Все файлы в одной папке `var/inbox`.

**Оптимизация**: Организовать файлы по подпапкам:
```
var/inbox/
  photo/
    2024/
      01/
  video/
    2024/
      01/
  audio/
    2024/
      01/
```

**Преимущества**:
- Легче найти файлы
- Проще управление (очистка старых файлов)
- Меньше файлов в одной папке

**Недостатки**:
- Усложнение логики
- Нужна миграция существующих файлов

### 5. Ограничение размера файлов

**Текущая реализация**: Сохраняются файлы любого размера.

**Оптимизация**: Добавить лимит на размер файла.

```python
MAX_FILE_SIZE = 100 * 1024 * 1024  # 100 MB

async def _save_file_to_inbox(...):
    file = await bot.get_file(file_id)
    if file.file_size and file.file_size > MAX_FILE_SIZE:
        logger.warning(f"File too large: {file.file_size} bytes")
        return None
    # ... save file
```

**Преимущества**:
- Защита от переполнения диска
- Предсказуемое использование ресурсов

**Недостатки**:
- Некоторые файлы не будут сохранены
- Нужно уведомлять пользователя

### 6. Кэширование метаданных файлов

**Текущая реализация**: Метаданные файлов сохраняются в БД через middleware.

**Оптимизация**: Использовать кэш для быстрого доступа к метаданным.

**Преимущества**:
- Быстрее проверка существования файла
- Меньше запросов к БД

**Недостатки**:
- Дополнительная сложность
- Проблемы синхронизации

## Рекомендации

1. **Краткосрочно**: Реализовать вариант 1 (асинхронное сохранение) для улучшения производительности.

2. **Среднесрочно**: Добавить вариант 2 (фильтрация типов) для гибкости конфигурации.

3. **Долгосрочно**: Рассмотреть вариант 4 (организация по папкам) при росте количества файлов.

## Статус

- [x] Анализ проблемы
- [x] Реализация базового решения
- [x] Добавление поддержки всех типов файлов
- [x] Обновление middleware
- [ ] Тестирование на реальных данных
- [ ] Реализация оптимизаций (по необходимости)

